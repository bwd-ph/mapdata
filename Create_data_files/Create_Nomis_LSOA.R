library(tidyverse)
library(sqldf)
library(stringr)
library(readxl)

setwd('C:/Users/user/Documents/BwD work/Interactive Mapping/mapdata')

# NB - except for Standardised Ratios, the variable must already be in the Metadata.csv file, 
# because we need to take the England average from the 'DivergePoint' column
metadata <- read_csv("Metadata.csv")

# Reading Nomis data

PennineEthnicity <- read.csv('http://www.nomisweb.co.uk/api/v01/dataset/NM_608_1.data.csv?date=latest&geography=1249914809,1249914810,1249914833...1249914836,1249914783...1249914785,1249914789,1249914790,1249914776,1249914779,1249914780,1249914807,1249914808,1249914781,1249914782,1249914842,1249914845,1249914787,1249914788,1249914856...1249914858,1249914829,1249914831,1249914843,1249914844,1249914855,1249914773...1249914775,1249914777,1249914830,1249914778,1249914837...1249914841,1249914797,1249914798,1249914824...1249914827,1249914786,1249914811...1249914815,1249914802...1249914806,1249914832,1249914796,1249914820...1249914823,1249914795,1249914799...1249914801,1249914791...1249914793,1249914848,1249914852,1249914819,1249914846,1249914847,1249914850,1249914849,1249914851,1249914853,1249914854,1249914816...1249914818,1249914859...1249914861,1249914794,1249914828,1249934267,1249934268,1249926792,1249926794,1249926795,1249926824,1249926825,1249926827,1249926826,1249926829...1249926831,1249926789,1249926808...1249926811,1249926828,1249926816...1249926819,1249926822,1249926823,1249926812,1249926813,1249926845...1249926847,1249926814,1249926815,1249926835,1249926844,1249926788,1249926790,1249926791,1249926797,1249926796,1249926798...1249926800,1249926793,1249926801...1249926803,1249926805,1249926832,1249926833,1249926840...1249926842,1249926807,1249926820,1249926821,1249926834,1249926837,1249926839,1249926843,1249926804,1249926806,1249926836,1249926838,1249926991...1249926997,1249926965...1249926967,1249926979...1249926981,1249926984,1249927001...1249927005,1249926982,1249926983,1249926988...1249926990,1249926998...1249927000,1249926976...1249926978,1249927012,1249926974,1249926975,1249927013...1249927015,1249934957,1249926986,1249927006...1249927009,1249926968...1249926973,1249926985,1249926987,1249927010,1249927011,1249927119...1249927130,1249927133...1249927136,1249927148...1249927151,1249927106...1249927108,1249927131,1249927154...1249927156,1249927102...1249927105,1249927132,1249927139,1249927109...1249927112,1249927116,1249927117,1249927138,1249927145...1249927147,1249927152,1249927153,1249927157,1249927158,1249927115,1249927118,1249927137,1249927144,1249927113,1249927114,1249927140...1249927143,1249927242,1249927247,1249927258,1249927275,1249927276,1249927261,1249927271...1249927274,1249927256,1249927257,1249927262,1249927265,1249927266,1249927249,1249927253,1249927254,1249927269,1249927248,1249927267,1249927268,1249927270,1249927281,1249927243,1249927244,1249927252,1249927255,1249927245,1249927246,1249927260,1249927277,1249927278,1249927250,1249927251,1249927259,1249927263,1249927264,1249927279,1249927280,1249927282,1249927288,1249927289,1249927318,1249927290,1249927291,1249927293,1249927320...1249927323,1249927294...1249927296,1249927307...1249927309,1249927283,1249927299,1249927311,1249927312,1249935005,1249927303...1249927306,1249927284,1249927285,1249927292,1249927310,1249927286,1249927287,1249927301,1249927302,1249927298,1249927300,1249927316,1249927317,1249927319,1249927297,1249927313...1249927315&rural_urban=0&cell=0,100,9,10&measures=20100&select=geography_code,cell_name,obs_value')

# Data from Nomis is in tall format - want wide format
PennineEthnicity <- spread(PennineEthnicity,key = CELL_NAME,value = OBS_VALUE)
PennineEthnicity <- PennineEthnicity %>% mutate(Other = `All usual residents` - `Asian/Asian British: Indian` - `Asian/Asian British: Pakistani` - White) %>% rename(polycode = GEOGRAPHY_CODE,All = `All usual residents`,Indian = `Asian/Asian British: Indian`,Pakistani = `Asian/Asian British: Pakistani`)
PennineEthnicity <- PennineEthnicity %>% mutate(IndianPC = Indian/All*100,PakistaniPC = Pakistani/All*100,WhitePC = White/All*100,OtherPC = Other/All*100)

Indian <- PennineEthnicity %>% select(polycode,Indian,IndianPC) %>% add_column(IndID = "PC_Indian") %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
              "Population of Indian ethnicity = ",round(IndianPC,digits=1),"% (",Indian," people)","<br/>","<em>(2011 Census results)</em>")) %>%
  select(IndID,polycode,value = IndianPC,label)

Pakistani <- PennineEthnicity %>% select(polycode,Pakistani,PakistaniPC) %>% add_column(IndID = "PC_Pakistani") %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
                        "Population of Pakistani ethnicity = ",round(PakistaniPC,digits=1),"% (",Pakistani," people)","<br/>","<em>(2011 Census results)</em>")) %>%
  select(IndID,polycode,value = PakistaniPC,label)

White <- PennineEthnicity %>% select(polycode,White,WhitePC) %>% add_column(IndID = "PC_White") %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
                        "Population of White ethnicity = ",round(WhitePC,digits=1),"% (",White," people)","<br/>","<em>(2011 Census results)</em>")) %>%
  select(IndID,polycode,value = WhitePC,label)

Other <- PennineEthnicity %>% select(polycode,Other,OtherPC) %>% add_column(IndID = "PC_Mixed_Other") %>%
  mutate(label = paste0("LSOA: ",polycode,"<br/>",
                        "Population of ethnicity other than","<br /","White, Indian or Pakistani = ",round(OtherPC,digits=1),"% (",Other," people)","<br/>","<em>(2011 Census results)</em>")) %>%
  select(IndID,polycode,value = OtherPC,label)

PennineEthnicity <- bind_rows(Indian, Pakistani, White, Other)

write_csv(PennineEthnicity,"PennineNomis_LSOA.csv")

